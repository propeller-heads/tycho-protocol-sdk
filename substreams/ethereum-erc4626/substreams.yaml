specVersion: v0.1.0
package:
  name: "ethereum_erc4626"
  version: v0.1.0

protobuf:
  files:
    - tycho/evm/v1/vm.proto
    - tycho/evm/v1/common.proto
    - tycho/evm/v1/utils.proto
  importPaths:
    - ../../proto

binaries:
  default:
    type: wasm/rust-v1
    file: ../target/wasm32-unknown-unknown/release/ethereum_erc4626.wasm

modules:
  - name: map_protocol_components
    kind: map
    inputs:
      - params: string
      - source: sf.ethereum.type.v2.Block
    output:
      type: proto:tycho.evm.v1.BlockTransactionProtocolComponents

  - name: store_component_tokens
    kind: store
    updatePolicy: set
    valueType: string
    inputs:
      - map: map_protocol_components

  - name: map_relative_balances
    kind: map
    inputs:
      - source: sf.ethereum.type.v2.Block
      - store: store_component_tokens
    output:
      type: proto:tycho.evm.v1.BlockBalanceDeltas

  - name: store_component_balances
    kind: store
    updatePolicy: add
    valueType: bigint
    inputs:
      - map: map_relative_balances

  - name: store_component_first_interaction
    kind: store
    updatePolicy: set_if_not_exists
    valueType: bigint
    inputs:
      - source: sf.ethereum.type.v2.Block
      - map: map_relative_balances

  - name: map_protocol_changes
    kind: map
    inputs:
      - source: sf.ethereum.type.v2.Block
      - map: map_protocol_components
      - store: store_component_tokens
      - store: store_component_balances
        mode: deltas
      - map: map_relative_balances
      - store: store_component_first_interaction
    output:
      type: proto:tycho.evm.v1.BlockChanges

network: mainnet

params:
  map_protocol_components: 'address=28B3a8fb53B741A8Fd78c0fb9A6B2393d896a43d&tx_hash=20793bbf260912aae189d5d261ff003c9b9166da8191d8f9d63ff1c7722f3ac6&asset=A0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48&static_attribute_keys[]=name&static_attribute_vals[]=spUSDC#address=e2e7a17dFf93280dec073C995595155283e3C372&tx_hash=4fe047d7749d8c1fbfcad10ebd54dd34adeb296356d9c5d8a77f0a60e4c8bab2&asset=dAC17F958D2ee523a2206206994597C13D831ec7&static_attribute_keys[]=name&static_attribute_vals[]=spUSDT#address=fE6eb3b609a7C8352A241f7F3A21CEA4e9209B8f&tx_hash=e8e324769d1e79969eb2febc30dc3371a96cb428094782a8488dbeb6541dfe7f&asset=C02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2&static_attribute_keys[]=name&static_attribute_vals[]=spETH#address=a3931d71877C0E7a3148CB7Eb4463524FEc27fbD&tx_hash=e1be00c4ea3c21cf536b98ac082a5bba8485cf75d6b2b94f4d6e3edd06472c00&asset=dC035D45d973E3EC169d2276DDab16f1e407384F&static_attribute_keys[]=name&static_attribute_vals[]=sUSDS#address=Bc65ad17c5C0a2A4D159fa5a503f4992c7B545FE&tx_hash=549d8f23f755f10ac453949f7ce76f19cfd3007ca8402588fe66b0e54ada627c&asset=A0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48&static_attribute_keys[]=name&static_attribute_vals[]=sUSDC#address=83f20f44975d03b1b09e64809b757c47f942beea&tx_hash=a2f51048265f2fe9ffaf69b94cb5a2a4113be49bdecd2040d530dd6f68facc42&asset=6B175474E89094C44Da98b954EedeAC495271d0F&static_attribute_keys[]=name&static_attribute_vals[]=sDAI'
