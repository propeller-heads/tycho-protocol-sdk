#!/bin/bash

# Usage: RPC_URL=https://... bin/generate_abi

LMSR_HOME=../../../lmsr-amm
CHAIN_ID=1

if [ -z "$RPC_URL" ]; then
    echo "Error: RPC_URL environment variable is not set"
    exit 1
fi

abi() {
    jq '.abi' $LMSR_HOME/deployment/$CHAIN_ID/v1/out/$1.sol/$1.json > abi/$2.abi.json
    echo abi/$2.abi.json
}

code() {
  local contracts=("$@")
  local addrs=()
  local codes=()

  for name in "${contracts[@]}"; do
    addr=$(jq -r ".\"$CHAIN_ID\".v1.$name" $LMSR_HOME/deployment/liqp-deployments.json)
    addrs+=("$addr")
    codes+=($(cast code --rpc-url $RPC_URL "$addr"))
  done

  {
    echo "//"
    echo "// WARNING"
    echo "// This file is auto-generated by bin/generate_abi. Do not edit manually."
    echo "//"
    echo
    echo "pub const LIQP_EXTRA_CONTRACTS: &[([u8; 20], &[u8])] = &["
    for i in "${!contracts[@]}"; do
      # Convert address to byte array
      addr_hex="${addrs[$i]#0x}"
      echo "    // ${contracts[$i]}"
      echo -n "    (["
      for ((j=0; j<${#addr_hex}; j+=2)); do
        echo -n "0x${addr_hex:$j:2}"
        [ $j -lt $((${#addr_hex}-2)) ] && echo -n ", "
      done
      echo -n "], &["

      # Convert hex bytecode to byte array
      code_hex="${codes[$i]#0x}"
      for ((j=0; j<${#code_hex}; j+=2)); do
        echo -n "0x${code_hex:$j:2}"
        [ $j -lt $((${#code_hex}-2)) ] && echo -n ", "
      done
      echo "]),"
    done
    echo "];"
  } > src/contract_bytecode.rs
}

# Copy ABI's to json files under abi/
abi PartyPlanner party_planner
abi PartyPool party_pool
abi PartyInfo party_info

# Generate contract_bytecode.rs from the bytecode of helper contracts
code PartyPoolMintImpl PartyPoolSwapImpl PartyInfo

cargo +nightly fmt
