specVersion: v0.1.0
package:
  name: "ethereum_balancer_v3"
  version: v0.4.0

protobuf:
  files:
    - tycho/evm/v1/vm.proto
    - tycho/evm/v1/common.proto
    - tycho/evm/v1/utils.proto
  importPaths:
    - ../../proto

binaries:
  default:
    type: wasm/rust-v1
    file: ../target/wasm32-unknown-unknown/release/ethereum_balancer_v3.wasm

modules:
  - name: map_components
    kind: map
    initialBlock: 21332121
    inputs:
      - params: string
      - source: sf.ethereum.type.v2.Block
    output:
      type: proto:tycho.evm.v1.BlockTransactionProtocolComponents

  - name: store_components
    kind: store
    initialBlock: 21332121
    updatePolicy: set_if_not_exists
    valueType: proto:tycho.evm.v1.ProtocolComponents
    inputs:
      - map: map_components

  - name: store_token_set
    kind: store
    initialBlock: 21332121
    updatePolicy: set_if_not_exists
    valueType: int64
    inputs:
      - map: map_components

  - name: map_relative_balances
    kind: map
    initialBlock: 21332121
    inputs:
      - source: sf.ethereum.type.v2.Block
      - store: store_components
    output:
      type: proto:tycho.evm.v1.BlockBalanceDeltas

  - name: store_balances
    kind: store
    initialBlock: 21332121
    updatePolicy: add
    valueType: bigint
    inputs:
      - map: map_relative_balances

  - name: map_protocol_changes
    kind: map
    initialBlock: 21332121
    inputs:
      - params: string
      - source: sf.ethereum.type.v2.Block
      - map: map_components
      - map: map_relative_balances
      - store: store_components
      - store: store_token_set
      - store: store_balances
        mode: deltas # This is the key property that simplifies `BalanceChange` handling
    output:
      type: proto:tycho.evm.v1.BlockChanges

network: mainnet

params:
  map_components: "7bc3485026ac48b6cf9baf0a377477fff5703af8=dac17f958d2ee523a2206206994597c13d831ec7&0bfc9d54fc184518a81162f8fb99c2eaca081202=c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2&7204b7dbf9412567835633b6f00c3edc3a8d6330=a0b86991c6218b36c1d19d4a2e9eb0ce3606eb48&775f661b0bd1739349b9a2a3ef60be277c5d2d29=7f39c581f595b53c5cb19bd0b3f8da6c935e2ca0&c71ea051a5f82c67adcf634c36ffe6334793d24c=40d16fc0246ad3160ccc09b8d0d3a2cd28ae6c2f&097ffedb80d4b2ca6105a07a4d90eb739c45a666=dac17f958d2ee523a2206206994597c13d831ec7&3976d71e7ddfbab9bd120ec281b7d35fa0f28528=a684eaf215ad323452e2b2bf6f817d4aa5c116ab&bfb53910c935e837c74e6c4ef584557352d20fde=0eecbdbf7331b8a50fcd0bf2c267bf47bd876054&30881baa943777f92dc934d53d3bfdf33382cab3=7b43e3875440b44613dc3bc08e7763e6da63c8f8&beefc01767ed5086f35decb6c00e6c12bc7476c1=7751e2f4b8ae93ef6b79d86419d42fe3295a4559&2411802d8bea09be0af8fd8d08314a63e706b29c=7f39c581f595b53c5cb19bd0b3f8da6c935e2ca0&c824a08db624942c5e5f330d56530cd1598859fd=a1290d69c65a6fe4df752f95823fae25cb99e5a7&bb22d59b73d7a6f3a8a83a214becc67eb3b511fe=c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2&1202f5c7b4b9e47a1a484e8b270be34dbbc75055=66a1e37c9b0eaddca17d3662d6c05f4decf3e110&7a4effd87c2f3c55ca251080b1343b605f327e3a=7f39c581f595b53c5cb19bd0b3f8da6c935e2ca0&0fe906e030a44ef24ca8c7dc7b7c53a6c4f00ce9=c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2&beef01735c132ada46aa9aa4c54623caa92a64cb=a0b86991c6218b36c1d19d4a2e9eb0ce3606eb48&7751e2f4b8ae93ef6b79d86419d42fe3295a4559=bdc7c08592ee4aa51d06c27ee23d5087d65adbcd&2371e134e3455e0593363cbf89d3b6cf53740618=c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2&1e6ffa4e9f63d10b8820a3ab52566af881dab53c=c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2&d9a442856c234a39a81a089c06451ebaa4306a72=c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2&9d39a5de30e57443bff2a8307a4256c8797a3497=4c9edd5852cd905f086c759e8383e09bff1e68b3&d4fa2d31b7968e448877f69a96de69f5de8cd23e=a0b86991c6218b36c1d19d4a2e9eb0ce3606eb48&a1b60d96e5c50da627095b9381dc5a46af1a9a42=c83e27f270cce0a3a3a29521173a83f402c1768b&83f20f44975d03b1b09e64809b757c47f942beea=6b175474e89094c44da98b954eedeac495271d0f&b51edddd8c47856d81c8681ea71404cec93e92c6=6c3ea9036406852006290770bedfcaba0e23a0e8&6a1792a91c08e9f0bfe7a990871b786643237f0f=8292bb45bf1ee4d140127049757c2e0ff06317ed&dbdc1ef57537e34680b898e1febd3d68c7389bcb=48f9e38f3070ad8945dfeae3fa70987722e3d89c&90551c1795392094fe6d29b758eccd233cfaa260=c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2&5f9d59db355b4a60501544637b00e94082ca575b=4c9edd5852cd905f086c759e8383e09bff1e68b3&beefc011e94f43b8b7b455ebab290c7ab4e216f1=7751e2f4b8ae93ef6b79d86419d42fe3295a4559"
  map_protocol_changes: "7bc3485026ac48b6cf9baf0a377477fff5703af8=dac17f958d2ee523a2206206994597c13d831ec7&0bfc9d54fc184518a81162f8fb99c2eaca081202=c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2&7204b7dbf9412567835633b6f00c3edc3a8d6330=a0b86991c6218b36c1d19d4a2e9eb0ce3606eb48&775f661b0bd1739349b9a2a3ef60be277c5d2d29=7f39c581f595b53c5cb19bd0b3f8da6c935e2ca0&c71ea051a5f82c67adcf634c36ffe6334793d24c=40d16fc0246ad3160ccc09b8d0d3a2cd28ae6c2f&097ffedb80d4b2ca6105a07a4d90eb739c45a666=dac17f958d2ee523a2206206994597c13d831ec7&3976d71e7ddfbab9bd120ec281b7d35fa0f28528=a684eaf215ad323452e2b2bf6f817d4aa5c116ab&bfb53910c935e837c74e6c4ef584557352d20fde=0eecbdbf7331b8a50fcd0bf2c267bf47bd876054&30881baa943777f92dc934d53d3bfdf33382cab3=7b43e3875440b44613dc3bc08e7763e6da63c8f8&beefc01767ed5086f35decb6c00e6c12bc7476c1=7751e2f4b8ae93ef6b79d86419d42fe3295a4559&2411802d8bea09be0af8fd8d08314a63e706b29c=7f39c581f595b53c5cb19bd0b3f8da6c935e2ca0&c824a08db624942c5e5f330d56530cd1598859fd=a1290d69c65a6fe4df752f95823fae25cb99e5a7&bb22d59b73d7a6f3a8a83a214becc67eb3b511fe=c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2&1202f5c7b4b9e47a1a484e8b270be34dbbc75055=66a1e37c9b0eaddca17d3662d6c05f4decf3e110&7a4effd87c2f3c55ca251080b1343b605f327e3a=7f39c581f595b53c5cb19bd0b3f8da6c935e2ca0&0fe906e030a44ef24ca8c7dc7b7c53a6c4f00ce9=c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2&beef01735c132ada46aa9aa4c54623caa92a64cb=a0b86991c6218b36c1d19d4a2e9eb0ce3606eb48&7751e2f4b8ae93ef6b79d86419d42fe3295a4559=bdc7c08592ee4aa51d06c27ee23d5087d65adbcd&2371e134e3455e0593363cbf89d3b6cf53740618=c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2&1e6ffa4e9f63d10b8820a3ab52566af881dab53c=c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2&d9a442856c234a39a81a089c06451ebaa4306a72=c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2&9d39a5de30e57443bff2a8307a4256c8797a3497=4c9edd5852cd905f086c759e8383e09bff1e68b3&d4fa2d31b7968e448877f69a96de69f5de8cd23e=a0b86991c6218b36c1d19d4a2e9eb0ce3606eb48&a1b60d96e5c50da627095b9381dc5a46af1a9a42=c83e27f270cce0a3a3a29521173a83f402c1768b&83f20f44975d03b1b09e64809b757c47f942beea=6b175474e89094c44da98b954eedeac495271d0f&b51edddd8c47856d81c8681ea71404cec93e92c6=6c3ea9036406852006290770bedfcaba0e23a0e8&6a1792a91c08e9f0bfe7a990871b786643237f0f=8292bb45bf1ee4d140127049757c2e0ff06317ed&dbdc1ef57537e34680b898e1febd3d68c7389bcb=48f9e38f3070ad8945dfeae3fa70987722e3d89c&90551c1795392094fe6d29b758eccd233cfaa260=c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2&5f9d59db355b4a60501544637b00e94082ca575b=4c9edd5852cd905f086c759e8383e09bff1e68b3&beefc011e94f43b8b7b455ebab290c7ab4e216f1=7751e2f4b8ae93ef6b79d86419d42fe3295a4559"