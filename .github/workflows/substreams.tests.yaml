name: Substreams Tests

env:
  RPC_URL: ${{ secrets.ETH_RPC_URL }}
  SUBSTREAMS_API_TOKEN: ${{ secrets.SUBSTREAMS_API_TOKEN }}
  AUTH_API_KEY: ${{ secrets.AUTH_API_KEY }}
  EXCLUDED_SUBSTREAMS: target|crates|ethereum-template-factory|ethereum-template-singleton

on:
  workflow_dispatch:
    inputs:
      protocols:
        description: 'Space-separated list of protocols to test (leave empty for all)'
        required: false
        default: ''
        type: string
  pull_request:

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      protocol-testing-changed: ${{ steps.protocol-testing-files-changed.outputs.any_changed }}
      substreams-changed: ${{ steps.substreams-files-changed.outputs.any_changed }}
      all-substreams: ${{ steps.all_substreams.outputs.all_substreams }}
      changed-substreams: ${{ steps.changes.outputs.changed_substreams }}
      target-protocols: ${{ steps.target-protocols.outputs.protocols }}
      protocols-matrix: ${{ steps.protocols-matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4

      - name: Check if any files changed under protocol-testing
        id: protocol-testing-files-changed
        uses: tj-actions/changed-files@v35
        with:
          files: protocol-testing/**

      - name: Check if any files changed under substreams
        id: substreams-files-changed
        uses: tj-actions/changed-files@v35
        with:
          files: substreams/**

      - name: Check if Dockerfile changed
        id: dockerfile-changed
        uses: tj-actions/changed-files@v35
        with:
          files: protocol-testing/run.Dockerfile

      - name: Check if Cargo.toml changed
        id: cargo-toml-changed
        uses: tj-actions/changed-files@v35
        with:
          files: protocol-testing/Cargo.toml

      - name: Get all substreams folders
        id: all_substreams
        run: |
          FOLDERS=$(find substreams -mindepth 1 -maxdepth 1 -type d \
            -exec basename {} \; | sort | \
            grep -v -E "^(${EXCLUDED_SUBSTREAMS})$" | \
            tr '\n' ' ')
          if [ -z "$FOLDERS" ]; then
            echo "No substreams folders found"
          else
            echo "Substreams folders: $FOLDERS"
          fi
          echo "all_substreams=$FOLDERS" >> $GITHUB_OUTPUT

      - name: Fetch full git history
        if: steps.substreams-files-changed.outputs.any_changed == 'true'
        run: git fetch --unshallow || true

      - name: Get changed substreams folders
        id: changes
        if: steps.substreams-files-changed.outputs.any_changed == 'true'
        run: |
          CHANGED=$(git diff --name-only origin/main ${{ github.sha }} | \
            grep '^substreams/' | awk -F'/' '{print $2}' | sort -u | \
            grep -v -E "^(${EXCLUDED_SUBSTREAMS})$" | tr '\n' ' ' | sed 's/ *$//')
          if [ -z "$CHANGED" ]; then
              echo "No changed substreams"
          else
              echo "Changed substreams: $CHANGED"
          fi
          echo "changed_substreams=$CHANGED" >> $GITHUB_OUTPUT

      - name: Determine target protocols
        id: target-protocols
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            if [[ -n "${{ github.event.inputs.protocols }}" ]]; then
              PROTOCOLS="${{ github.event.inputs.protocols }}"
              echo "Using manually specified protocols: $PROTOCOLS"
            else
              PROTOCOLS="${{ steps.all_substreams.outputs.all_substreams }}"
              echo "Using all protocols: $PROTOCOLS"
            fi
          elif [[ "${{ steps.dockerfile-changed.outputs.any_changed }}" == "true" ]]; then
            PROTOCOLS="${{ steps.all_substreams.outputs.all_substreams }}"
            echo "Dockerfile changed, testing all protocols: $PROTOCOLS"
          elif [[ "${{ steps.cargo-toml-changed.outputs.any_changed }}" == "true" ]]; then
            PROTOCOLS="${{ steps.all_substreams.outputs.all_substreams }}"
            echo "Cargo.toml changed, testing all protocols: $PROTOCOLS"
          elif [[ "${{ steps.substreams-files-changed.outputs.any_changed }}" == "true" ]]; then
            PROTOCOLS="${{ steps.changes.outputs.changed_substreams }}"
            echo "Using changed protocols: $PROTOCOLS"
          else
            PROTOCOLS=""
            echo "No protocols to test"
          fi
          echo "protocols=$PROTOCOLS" >> $GITHUB_OUTPUT

      - name: Create protocols matrix
        id: protocols-matrix
        run: |
          PROTOCOLS="${{ steps.target-protocols.outputs.protocols }}"
          if [[ -z "$PROTOCOLS" ]]; then
            echo "matrix={\"include\":[]}" >> $GITHUB_OUTPUT
          else
            MATRIX_JSON="{\"include\":["
            FIRST=true
            for protocol in $PROTOCOLS; do
              if [[ "$FIRST" == "true" ]]; then
                FIRST=false
              else
                MATRIX_JSON+=","
              fi
              MATRIX_JSON+="{\"protocol\":\"$protocol\"}"
            done
            MATRIX_JSON+="]}"
            echo "matrix=$MATRIX_JSON" >> $GITHUB_OUTPUT
            echo "Generated matrix: $MATRIX_JSON"
          fi

  # Build shared docker images once
  build-images:
    runs-on: ubuntu-latest
    needs: [ detect-changes ]
    if: needs.detect-changes.outputs.target-protocols != ''
    outputs:
      cache-key: ${{ steps.cache-key.outputs.key }}
    steps:
      - uses: actions/checkout@v4

      - name: Generate cache key
        id: cache-key
        run: |
          KEY="docker-images-${{ hashFiles('protocol-testing/postgres.Dockerfile', 'protocol-testing/run.Dockerfile') }}-${{ github.sha }}"
          echo "key=$KEY" >> $GITHUB_OUTPUT

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      - name: Build and cache DB image
        run: |
          docker buildx build \
            --cache-from type=local,src=/tmp/.buildx-cache \
            --cache-to type=local,dest=/tmp/.buildx-cache \
            -f protocol-testing/postgres.Dockerfile \
            -t protocol-testing-db:latest \
            --load .
          docker save protocol-testing-db:latest -o /tmp/db-image.tar

      - name: Build and cache test-runner image
        run: |
          docker buildx build \
            --cache-from type=local,src=/tmp/.buildx-cache \
            --cache-to type=local,dest=/tmp/.buildx-cache \
            --build-arg PROTOCOLS="${{ needs.detect-changes.outputs.target-protocols }}" \
            -f protocol-testing/run.Dockerfile \
            -t protocol-testing-test-runner:latest \
            --load .
          docker save protocol-testing-test-runner:latest -o /tmp/test-runner-image.tar

      - name: Upload docker images
        uses: actions/upload-artifact@v4
        with:
          name: docker-images-${{ steps.cache-key.outputs.key }}
          path: |
            /tmp/db-image.tar
            /tmp/test-runner-image.tar
          retention-days: 1

  # Parallel execution for each protocol
  test-protocols:
    runs-on: ubuntu-latest
    needs: [ detect-changes, build-images ]
    if: needs.detect-changes.outputs.target-protocols != ''
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.detect-changes.outputs.protocols-matrix) }}
    steps:
      - uses: actions/checkout@v4

      - name: Download docker images
        uses: actions/download-artifact@v4
        with:
          name: docker-images-${{ needs.build-images.outputs.cache-key }}
          path: /tmp

      - name: Load docker images
        run: |
          docker load -i /tmp/db-image.tar
          docker load -i /tmp/test-runner-image.tar

      - name: Run protocol test
        uses: ./.github/actions/substreams-docker-single
        with:
          protocol: ${{ matrix.protocol }}

  # Skip job when no protocols need testing
  skip-tests:
    runs-on: ubuntu-latest
    needs: [ detect-changes ]
    if: needs.detect-changes.outputs.target-protocols == ''
    steps:
      - name: Skip tests
        run: echo "âœ“ No protocols to test - skipping"
